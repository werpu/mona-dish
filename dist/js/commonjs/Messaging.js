!function(){"use strict";var e={484:function(e,t,s){s.d(t,{Es2019Array:function(){return r}});class r extends Array{constructor(...e){if(super(...e),!Array.prototype.flatMap){let e=r.prototype.flatMap_;this.flatMap=e}}flatMap_(e,t=!1){let s=[],i=t=>{let r=e(t);if(Array.isArray(r)){if(1==r.length)return void s.push(r[1]);r.length>1&&r.forEach((e=>i(e)))}else s.push(t)};return this.forEach((e=>i(e))),new r(...s)}concat(...e){return new r(...super.concat(...e))}reverse(){return new r(...super.reverse())}slice(e,t){return new r(...super.slice(e,t))}splice(e,t){return new r(...super.splice(e,t))}filter(e,t){return new r(...super.filter(e,t))}}},456:function(e,t,s){function r(){var e;let t="undefined"!=typeof globalThis&&globalThis.window?globalThis.window:"undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:void 0!==s.g&&(null===s.g||void 0===s.g?void 0:s.g.window)?s.g.window:void 0!==s.g?s.g:null;return null!==(e=null==t?void 0:t.window)&&void 0!==e?e:t}s.d(t,{R:function(){return r}})},805:function(e,t,s){s.d(t,{Lang:function(){return r}});var r,i=s(152);!function(e){function t(e){let t=/\s/,s=(e=e.replace(/^\s\s*/,"")).length;for(;t.test(e.charAt(--s)););return e.slice(0,s+1)}function s(e){return!!arguments.length&&null!=e&&("string"==typeof e||e instanceof String)}e.saveResolve=function(e,t=null){try{let s=e();return i.Optional.fromNullable(null!=s?s:t)}catch(e){return i.Optional.absent}},e.saveResolveLazy=function(e,t=null){try{let s=e();return i.Optional.fromNullable(null!=s?s:t())}catch(e){return i.Optional.absent}},e.strToArray=function(e,s=/\./gi){let r=[];return e.split(s).forEach((e=>{r.push(t(e))})),r},e.trim=t,e.objToArray=function(e,t=0,s=[]){return"__undefined__"==(null!=e?e:"__undefined__")?null!=s?s:null:e instanceof Array&&!t&&!s?e:s.concat(Array.prototype.slice.call(e,t))},e.equalsIgnoreCase=function(e,t){let s=null!=t?t:"___no_value__";return(null!=e?e:"___no_value__").toLowerCase()===s.toLowerCase()},e.assertType=function(e,t){return s(t)?typeof e==t:e instanceof t},e.isString=s,e.isFunc=function(e){return e instanceof Function||"function"==typeof e},e.objAssign=function(e,...t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");let s=Object(e);return Object.assign?(t.forEach((e=>Object.assign(s,e))),s):(t.filter((e=>null!=e)).forEach((e=>{let t=e;Object.keys(t).filter((e=>Object.prototype.hasOwnProperty.call(t,e))).forEach((e=>s[e]=t[e]))})),s)}}(r||(r={}))},152:function(e,t,s){s.d(t,{Optional:function(){return l}});var r=s(805),i=s(484);r.Lang.objAssign;class n{constructor(e){this._value=e}get value(){return this._value}map(e){e||(e=e=>e);let t=e(this.value);return new n(t)}flatMap(e){let t=this.map(e);for(;(null==t?void 0:t.value)instanceof n;)t=t.value;return t}}class l extends n{constructor(e){super(e)}get value(){return this._value instanceof n?this._value.flatMap().value:this._value}static fromNullable(e){return new l(e)}isAbsent(){return void 0===this.value||null==this.value}isPresent(e){let t=this.isAbsent();return!t&&e&&e.call(this,this),!t}ifPresentLazy(e=(()=>{})){return this.isPresent.call(this,e),this}orElse(e){return this.isPresent()?this:null==e?l.absent:this.flatMap((()=>e))}orElseLazy(e){return this.isPresent()?this:this.flatMap(e)}flatMap(e){let t=super.flatMap(e);return t instanceof l?t.flatMap():l.fromNullable(t.value)}getIf(...e){e=this.preprocessKeys(...e);let t=this;for(let s=0;s<e.length;s++){let r=this.keyVal(e[s]),i=this.arrayIndex(e[s]);if(""===r&&i>=0){if(t=this.getClass().fromNullable(t.value instanceof Array?t.value.length<i?null:t.value[i]:null),t.isAbsent())return t}else if(r&&i>=0){if(t.getIfPresent(r).isAbsent())return t;if(t=t.getIfPresent(r).value instanceof Array?this.getClass().fromNullable(t.getIfPresent(r).value[i]):this.getClass().absent,t.isAbsent())return t}else{if(t=t.getIfPresent(r),t.isAbsent())return t;i>-1&&(t=this.getClass().fromNullable(t.value[i]))}}return t}match(e){return!this.isAbsent()&&e(this.value)}get(e=l.absent){return this.isAbsent()?this.getClass().fromNullable(e).flatMap():this.getClass().fromNullable(this.value).flatMap()}toJson(){return JSON.stringify(this.value)}getClass(){return l}arrayIndex(e){let t=e.indexOf("["),s=e.indexOf("]");return t>=0&&s>0&&t<s?parseInt(e.substring(t+1,s)):-1}keyVal(e){let t=e.indexOf("[");return t>=0?e.substring(0,t):e}getIfPresent(e){return this.isAbsent()?this.getClass().absent:this.getClass().fromNullable(this.value[e]).flatMap()}resolve(e){if(this.isAbsent())return l.absent;try{return l.fromNullable(e(this.value))}catch(e){return l.absent}}preprocessKeys(...e){return new i.Es2019Array(...e).flatMap((e=>new i.Es2019Array(...e.split(/]\s*\[/gi)).map((e=>(-1==(e=e.replace(/^\s+|\s+$/g,"")).indexOf("[")&&-1!=e.indexOf("]")&&(e="["+e),-1==e.indexOf("]")&&-1!=e.indexOf("[")&&(e+="]"),e)))))}}l.absent=l.fromNullable(null);class a extends l{constructor(e,t="value"){super(e),this.key=t}get value(){return this._value?this._value[this.key]:null}set value(e){this._value&&(this._value[this.key]=e)}orElse(e){let t={};return t[this.key]=e,this.isPresent()?this:new a(t,this.key)}orElseLazy(e){if(this.isPresent())return this;{let t={};return t[this.key]=e(),new a(t,this.key)}}getClass(){return a}static fromNullable(e,t="value"){return new a(e,t)}}a.absent=a.fromNullable(null);class o extends a{constructor(e,t,s){super(e,t),this.arrPos=null!=s?s:-1}get value(){return""==this.key&&this.arrPos>=0?this._value[this.arrPos]:this.key&&this.arrPos>=0?this._value[this.key][this.arrPos]:this._value[this.key]}set value(e){""==this.key&&this.arrPos>=0?this._value[this.arrPos]=e:this.key&&this.arrPos>=0?this._value[this.key][this.arrPos]=e:this._value[this.key]=e}}o.absent=o.fromNullable(null)},255:function(e,t,s){s.d(t,{dD:function(){return r}});var r;s(152),s(484);!function(e){e.EO_STRM="__EO_STRM__",e.BEF_STRM="___BEF_STRM__"}(r||(r={}))},551:function(e,t,s){s.d(t,{Stream:function(){return n}});var r=s(152),i=s(255);class n{constructor(...e){this._limits=-1,this.pos=-1,this.value=e}static of(...e){return new n(...e)}static ofAssoc(e){return this.of(...Object.keys(e)).map((t=>[t,e[t]]))}static ofDataSource(e){let t=[];for(;e.hasNext();)t.push(e.next());return new n(...t)}static ofDomQuery(e){return n.of(...e.asArray)}static ofConfig(e){return n.of(...Object.keys(e.value)).map((t=>[t,e.value[t]]))}current(){return-1==this.pos?i.dD.BEF_STRM:this.pos>=this.value.length?i.dD.EO_STRM:this.value[this.pos]}limits(e){return this._limits=e,this}concat(...e){let t=[this].concat(e);return n.of(...t).flatMap((e=>e))}onElem(e){for(let t=0;t<this.value.length&&(-1==this._limits||t<this._limits)&&!1!==e(this.value[t],t);t++);return this}each(e){this.onElem(e),this.reset()}map(e){e||(e=e=>e);let t=[];return this.each((s=>{t.push(e(s))})),new n(...t)}flatMap(e){let t=[];return this.each((s=>{let r=e(s);t=Array.isArray(r)?t.concat(r):t.concat(r.value)})),n.of(...t)}filter(e){let t=[];return this.each((s=>{e(s)&&t.push(s)})),new n(...t)}reduce(e,t=null){let s=null!=t?0:1,i=null!=t?t:this.value.length?this.value[0]:null;for(let t=s;t<this.value.length&&(-1==this._limits||t<this._limits);t++)i=e(i,this.value[t]);return this.reset(),r.Optional.fromNullable(i)}first(){return this.reset(),this.value&&this.value.length?r.Optional.fromNullable(this.value[0]):r.Optional.absent}last(){let e=this._limits>0?Math.min(this._limits,this.value.length):this.value.length;return this.reset(),r.Optional.fromNullable(e?this.value[e-1]:null)}anyMatch(e){for(let t=0;t<this.value.length&&(-1==this._limits||t<this._limits);t++)if(e(this.value[t]))return!0;return this.reset(),!1}allMatch(e){if(!this.value.length)return!1;let t=0;for(let s=0;s<this.value.length;s++)e(this.value[s])&&t++;return this.reset(),t==this.value.length}noneMatch(e){let t=0;for(let s=0;s<this.value.length;s++)e(this.value[s])||t++;return this.reset(),t==this.value.length}sort(e){let t=this.value.slice().sort(e);return n.of(...t)}collect(e){return this.each((t=>e.collect(t))),this.reset(),e.finalValue}hasNext(){let e=-1!=this._limits&&this.pos>=this._limits-1,t=this.pos>=this.value.length-1;return!(e||t)}next(){return this.hasNext()?(this.pos++,this.value[this.pos]):null}lookAhead(e=1){return this.pos+e>=this.value.length?i.dD.EO_STRM:this.value[this.pos+e]}[Symbol.iterator](){return{next:()=>({done:!this.hasNext(),value:this.next()})}}reset(){this.pos=-1}}class l{constructor(e){this._limits=-1,this.pos=-1,this.dataSource=e}static of(...e){return new l(new ArrayStreamDataSource(...e))}static ofAssoc(e){return this.of(...Object.keys(e)).map((t=>[t,e[t]]))}static ofStreamDataSource(e){return new l(e)}static ofDomQuery(e){return l.of(...e.asArray)}static ofConfig(e){return l.of(...Object.keys(e.value)).map((t=>[t,e.value[t]]))}hasNext(){return!this.isOverLimits()&&this.dataSource.hasNext()}next(){let e=this.dataSource.next();return this.pos++,e}lookAhead(e=1){return this.dataSource.lookAhead(e)}current(){return this.dataSource.current()}reset(){this.dataSource.reset(),this.pos=-1,this._limits=-1}concat(...e){return l.ofStreamDataSource(new MultiStreamDatasource(this,e))}nextFilter(e){if(this.hasNext()){let t=this.next();return e(t)?t:this.nextFilter(e)}return null}limits(e){return this._limits=e,this}collect(e){for(;this.hasNext();){let t=this.next();e.collect(t)}return this.reset(),e.finalValue}onElem(e){return new l(new MappedStreamDataSource((t=>(!1===e(t,this.pos)&&this.stop(),t)),this))}filter(e){return new l(new FilteredStreamDatasource(e,this))}map(e){return new l(new MappedStreamDataSource(e,this))}flatMap(e){return new l(new FlatMapStreamDataSource(e,this))}each(e){for(;this.hasNext();)!1===e(this.next())&&this.stop();this.reset()}reduce(e,t=null){if(!this.hasNext())return Optional.absent;let s,r=null;if(null!=t)t,this.next();else{if(this.next(),!this.hasNext())return Optional.fromNullable(s);this.next()}for(e(s,r);this.hasNext();)this.next(),e(s,r);return this.reset(),Optional.fromNullable(s)}last(){return this.hasNext()?this.reduce(((e,t)=>t)):Optional.absent}first(){return this.reset(),this.hasNext()?Optional.fromNullable(this.next()):Optional.absent}anyMatch(e){for(;this.hasNext();)if(e(this.next()))return!0;return!1}allMatch(e){for(;this.hasNext();)if(!e(this.next()))return!1;return!0}noneMatch(e){for(;this.hasNext();)if(e(this.next()))return!1;return!0}sort(e){let t=this.collect(new ArrayCollector);return t.sort(e),l.of(...t)}get value(){return this.collect(new ArrayCollector)}[Symbol.iterator](){return{next:()=>({done:!this.hasNext(),value:this.next()})}}stop(){this.pos=this._limits+1e9,this._limits=0}isOverLimits(){return-1!=this._limits&&this.pos>=this._limits-1}}}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,s),n.exports}s.d=function(e,t){for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};!function(){s.r(r),s.d(r,{BroadcastChannelBroker:function(){return d},BroadcastChannelBrokerBuilder:function(){return f},Broker:function(){return p},BrokerBuilder:function(){return v},Message:function(){return a},NoCrypto:function(){return n}});var e=require("rxjs"),t=s(551),i=s(456);class n{decode(e){return e}encode(e){return e}}let l=new n;class a{constructor(e={},t="*"){this.message=e,this.encoded=!1,this.targetOrigin=t,this.creationDate=(new Date).getMilliseconds(),this.identifier=(new Date).getMilliseconds()+"_"+Math.random()+"_"+Math.random()}}class o{constructor(e,t){this.detail=t,this.bubbles=!0,this.cancelable=!0,this.composed=!0,this.channel=e}}class h{constructor(){this.messageListeners={},this.subjects={},this.processedMessages={},this.cleanupCnt=0,this.TIMEOUT_IN_MS=1e3,this.MSG_EVENT="message",this.crypto=l}registerListener(e,t){return this.reserveListenerNS(e),this.messageListeners[e].push((e=>{var s;e.identifier in this.processedMessages||(((null==e?void 0:e.encoded)||(null===(s=null==e?void 0:e.detail)||void 0===s?void 0:s.encoded))&&((null==e?void 0:e.detail)?(e.detail.message=this.crypto.decode(e.detail.message),e.detail.encoded=!1):(e.message=this.crypto.decode(e.message),e.encoded=!1)),t(e))})),this}asSubject(e){this.reserveSubjectNS(e);let t=this.subjects[e],s=t.next;return t.next=r=>{(null==r?void 0:r.detail)?s.call(t,null==r?void 0:r.detail):this.broadcast(e,r)},t}asObservable(e){return this.asSubject(e).asObservable()}reserveListenerNS(e){this.messageListeners[e]||(this.messageListeners[e]=[]),this.messageListeners["*"]||(this.messageListeners["*"]=[])}reserveSubjectNS(t){this.subjects[t]||(this.subjects[t]=new e.Subject),this.subjects["*"]||(this.subjects["*"]=new e.Subject)}unregisterListener(e,t){return this.messageListeners[e]=(this.messageListeners[e]||[]).filter((e=>e!==t)),this}answer(e,t,s){if("string"==typeof t&&(t=new a(t)),!h.isAnswer(t))return s.identifier=h.getAnswerId(t),this.broadcast(e,s),this}static getAnswerId(e){return"_r_"+e.identifier}static isAnswer(e){return 0==e.identifier.indexOf("_r_")}request(e,t){"string"==typeof t&&(t=new a(t));let s=t.identifier,r=new Promise(((t,r)=>{let i=null,n=r=>{r.identifier!=s&&r.identifier=="_r_"+s&&(clearTimeout(i),this.unregisterListener(e,n),t(r))};i=setTimeout((()=>{this.unregisterListener(e,n),r("request message performed, timeout, no return value")}),3e3),this.registerListener(e,n)}));return this.broadcast(e,t),r}gcProcessedMessages(){if(++this.cleanupCnt%10!=0)return;let e={};Object.keys(this.processedMessages).forEach((t=>{this.messageStillActive(t)||(e[t]=this.processedMessages[t])})),this.processedMessages=e}messageStillActive(e){return this.processedMessages[e]>(new Date).getMilliseconds()-this.TIMEOUT_IN_MS}markMessageAsProcessed(e){this.processedMessages[e.identifier]=e.creationDate}}h.EVENT_TYPE="brokerEvent";let u=e=>{var t;if(null===(t=(0,i.R)())||void 0===t?void 0:t.BroadcastChannel)return new((0,i.R)().BroadcastChannel)(e);throw Error("No Broadcast channel in the system, use a shim or provide a factory functionin the constructor")};const c="brokr";class d extends h{constructor(e=u,t="brokr",s=l){super(),this.brokerFactory=e,this.channelGroup=t,this.crypto=s,this.openChannels={},this.msgListener=e=>{var t,s;e.detail.encoded&&(e.detail.message=this.crypto.decode(e.detail.message),e.detail.encoded=!1);let r=e.detail,i=e.channel;return(null===(t=this.messageListeners)||void 0===t?void 0:t[i])&&(null===(s=this.messageListeners)||void 0===s||s[i].forEach((e=>{e(r)}))),this.markMessageAsProcessed(r),!0},this.crypto=s,this.register()}broadcast(e,t,s=!0){try{"string"==typeof t&&(t=new a(t));let r=JSON.stringify(t);t=JSON.parse(r);let i=new o(e,t);i.detail.message=this.crypto.encode(i.detail.message),i.detail.encoded=!0,(null==this?void 0:this.subjects[e])&&this.subjects[e].next(i),this.openChannels[this.channelGroup].postMessage(i),s&&this.msgListener(i)}finally{this.gcProcessedMessages()}return this}registerListener(e,t){return super.registerListener(e,t),this}register(){return this.openChannels[this.channelGroup]||(this.openChannels[this.channelGroup]=this.brokerFactory(this.channelGroup)),this.openChannels[this.channelGroup].addEventListener("message",this.msgListener),this}unregister(){return this.openChannels[this.channelGroup].close(),this}}class f{constructor(){this.broadCastChannelGenerator=u,this.channelGroup=c,this.crypto=l,this.listeners=[]}withGeneratorFunc(e){return this.broadCastChannelGenerator=e,this}withListener(e,...s){return t.Stream.of(...s).each((t=>{this.listeners.push({channel:e,listener:t})})),this}withChannelGroup(e){return this.channelGroup=e,this}withCrypto(e){return this.crypto=e,this}build(){let e=new d(this.broadCastChannelGenerator,this.channelGroup,this.crypto);return t.Stream.of(...this.listeners).each((t=>{e.registerListener(t.channel,t.listener)})),e}}class p extends h{constructor(e=window,t="brokr",s=l){super(),this.brokerGroup=t;let r=e=>{var t,s,r,i;let n=null!==(t=null==e?void 0:e.detail)&&void 0!==t?t:null===(s=null==e?void 0:e.data)||void 0===s?void 0:s.detail,l=null!==(i=null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.channel)&&void 0!==i?i:null==e?void 0:e.channel;if((null==n?void 0:n.identifier)&&(null==n?void 0:n.message)){let t=n;if(t.identifier in this.processedMessages)return;null==e||e.detail,this.broadcast(l,t)}};this.msgHandler=e=>r(e),this.crypto=s,this.register(e)}register(e){if(this.rootElem=e.host?e.host:e,e.host){e.host.setAttribute("data-broker","1")}else(null==e?void 0:e.setAttribute)&&e.setAttribute("data-broker","1");return this.rootElem.addEventListener(this.brokerGroup+"__||__"+p.EVENT_TYPE,this.msgHandler,{capture:!0}),this.rootElem.addEventListener(this.brokerGroup+"__||__"+p.EVENT_TYPE+this.MSG_EVENT,this.msgHandler,{capture:!0}),this}unregister(){return this.rootElem.removeEventListener(this.brokerGroup+"__||__"+p.EVENT_TYPE,this.msgHandler),this.rootElem.removeEventListener(this.brokerGroup+"__||__"+this.MSG_EVENT,this.msgHandler),this}broadcast(e,t){if("string"==typeof t&&(t=new a(t)),null==this?void 0:this.subjects[e]){let s=new o(e,t);s.detail.encoded||(s.detail.message=this.crypto.encode(s.detail.message),s.detail.encoded=!0),this.subjects[e].next(s)}try{this.dispatchUp(e,t,!1,!0),this.dispatchDown(e,t,!0,!1)}finally{this.gcProcessedMessages()}return this}dispatchUp(e,t,s=!0,r=!0){if(s||this.msgCallListeners(e,t),this.markMessageAsProcessed(t),null!=(0,i.R)().parent){let s=new o(e,t);(0,i.R)().parent.postMessage(JSON.parse(JSON.stringify(s)),t.targetOrigin)}r&&this.dispatchSameLevel(e,t)}dispatchSameLevel(e,t){let s=this.transformToEvent(e,t,!0);(0,i.R)().dispatchEvent(s)}dispatchDown(e,t,s=!0,r=!0){s||this.msgCallListeners(e,t),this.processedMessages[t.identifier]=t.creationDate;let i=this.transformToEvent(e,t);Array.prototype.slice.call(document.querySelectorAll("iframe")).forEach((s=>{let r=new o(e,t);s.contentWindow.postMessage(JSON.parse(JSON.stringify(r)),t.targetOrigin)})),Array.prototype.slice.call(document.querySelectorAll("[data-broker='1']")).forEach((e=>e.dispatchEvent(i))),r&&this.dispatchSameLevel(e,t)}msgCallListeners(e,t){let s=this.messageListeners[e];if(null==s?void 0:s.length){let e=e=>{e(t)};s.forEach(e)}}transformToEvent(e,t,s=!1){let r=new o(e,t);return r.bubbles=s,p.createCustomEvent(this.brokerGroup+"__||__"+p.EVENT_TYPE,r)}static createCustomEvent(e,t){if("function"!=typeof(0,i.R)().CustomEvent){let s=document.createEvent("HTMLEvents");return s.detail=t.detail,s.channel=t.channel,s.initEvent(e,t.bubbles,t.cancelable),s}{let s=new((0,i.R)().CustomEvent)(e,t);return s.channel=t.channel,s}}}class v{constructor(){this.scopeElement=window,this.channelGroup=c,this.crypto=l,this.listeners=[]}withScopeElement(e){return this.scopeElement=e,this}withListener(e,...s){return t.Stream.of(...s).each((t=>{this.listeners.push({channel:e,listener:t})})),this}withChannelGroup(e){return this.channelGroup=e,this}withCrypto(e){return this.crypto=e,this}build(){let e=new p(this.scopeElement,this.channelGroup,this.crypto);return t.Stream.of(...this.listeners).each((t=>{e.registerListener(t.channel,t.listener)})),e}}}();var i=exports;for(var n in r)i[n]=r[n];r.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})}();
//# sourceMappingURL=Messaging.js.map